# 刷题小程序系统 - 生产环境部署说明

## 📋 系统概述

本系统包含三个主要部分：
- **Admin管理后台**：Vue.js + Element Plus 构建的管理界面
- **Server后端服务**：Node.js + Koa + MySQL 构建的API服务
- **Mini-program小程序**：微信小程序前端

## 🛠️ 环境要求

### 服务器环境
- **操作系统**：Linux (推荐 Ubuntu 20.04+ 或 CentOS 7+)
- **Node.js**：v16.0+ (推荐 v18.x LTS)
- **MySQL**：v8.0+
- **Nginx**：v1.18+ (用于反向代理和静态文件服务)
- **PM2**：用于进程管理

### 开发环境
- **微信开发者工具**：最新版本
- **Git**：用于代码管理

## 📁 项目结构

```
miniprogram-1-mysql/
├── admin/                 # 管理后台
│   ├── src/
│   ├── public/
│   ├── package.json
│   └── vite.config.js
├── server/               # 后端服务
│   ├── controllers/
│   ├── models/
│   ├── routes/
│   ├── middlewares/
│   ├── config/
│   ├── public/
│   ├── package.json
│   └── app.js
├── miniprogram/          # 微信小程序
│   ├── pages/
│   ├── utils/
│   ├── app.js
│   └── app.json
└── 生产环境部署说明.md
```

## 🚀 部署步骤

### 第一步：服务器环境准备

#### 1.1 安装 Node.js
```bash
# 使用 NodeSource 安装 Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

#### 1.2 安装 MySQL
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server

# CentOS/RHEL
sudo yum install mysql-server

# 启动 MySQL 服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

#### 1.3 安装 Nginx
```bash
# Ubuntu/Debian
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx

# 启动 Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 1.4 安装 PM2
```bash
sudo npm install -g pm2
```

### 第二步：数据库配置

#### 2.1 创建数据库和用户
```sql
-- 登录 MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE question_bank_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'question_user'@'localhost' IDENTIFIED BY 'your_strong_password';

-- 授权
GRANT ALL PRIVILEGES ON question_bank_db.* TO 'question_user'@'localhost';
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

#### 2.2 配置数据库连接
编辑 `server/config/database.js`：
```javascript
module.exports = {
  development: {
    username: 'question_user',
    password: 'your_strong_password',
    database: 'question_bank_db',
    host: 'localhost',
    dialect: 'mysql',
    timezone: '+08:00'
  },
  production: {
    username: 'question_user',
    password: 'your_strong_password',
    database: 'question_bank_db',
    host: 'localhost',
    dialect: 'mysql',
    timezone: '+08:00',
    logging: false, // 生产环境关闭SQL日志
    pool: {
      max: 20,
      min: 0,
      acquire: 30000,
      idle: 10000
    }
  }
}
```

### 第三步：代码部署

#### 3.1 克隆代码
```bash
# 创建项目目录
sudo mkdir -p /var/www/question-bank
sudo chown -R $USER:$USER /var/www/question-bank
cd /var/www/question-bank

# 克隆代码（替换为实际仓库地址）
git clone https://github.com/your-username/miniprogram-1-mysql.git .
```

#### 3.2 安装依赖

**安装 Server 依赖：**
```bash
cd server
npm install --production
```

**安装 Admin 依赖：**
```bash
cd ../admin
npm install
```

#### 3.3 构建 Admin 前端
```bash
cd admin
npm run build
```

构建完成后，`dist` 目录将包含生产环境的静态文件。

### 第四步：配置服务

#### 4.1 配置 Nginx

创建 Nginx 配置文件 `/etc/nginx/sites-available/question-bank`：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为实际域名
    
    # 管理后台
    location / {
        root /var/www/question-bank/admin/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # API 服务
    location /api/ {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 静态文件服务
    location /uploads/ {
        alias /var/www/question-bank/server/public/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/question-bank /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 4.2 配置 PM2

创建 PM2 配置文件 `server/ecosystem.config.js`：

```javascript
module.exports = {
  apps: [{
    name: 'question-bank-server',
    script: 'app.js',
    cwd: '/var/www/question-bank/server',
    instances: 2, // 根据CPU核心数调整
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3002
    },
    error_file: '/var/log/pm2/question-bank-error.log',
    out_file: '/var/log/pm2/question-bank-out.log',
    log_file: '/var/log/pm2/question-bank-combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max_old_space_size=1024'
  }]
}
```

### 第五步：启动服务

#### 5.1 初始化数据库
```bash
cd /var/www/question-bank/server
NODE_ENV=production node -e "
const { sequelize } = require('./config/database');
sequelize.sync({ force: false }).then(() => {
  console.log('数据库同步完成');
  process.exit(0);
}).catch(err => {
  console.error('数据库同步失败:', err);
  process.exit(1);
});
"
```

#### 5.2 启动后端服务
```bash
cd /var/www/question-bank/server
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

#### 5.3 验证服务状态
```bash
# 检查 PM2 进程
pm2 status

# 检查服务日志
pm2 logs question-bank-server

# 检查端口监听
sudo netstat -tlnp | grep :3002

# 测试 API
curl http://localhost:3002/health
```

## 🔧 小程序配置

### 6.1 修改小程序配置

编辑 `miniprogram/utils/server-api.js`，更新服务器地址：

```javascript
// 生产环境配置
const getServerUrl = () => {
  return 'https://your-domain.com'  // 替换为实际域名
}
```

### 6.2 微信小程序配置

1. **登录微信公众平台**：https://mp.weixin.qq.com
2. **配置服务器域名**：
   - 在"开发" -> "开发管理" -> "开发设置"中添加服务器域名
   - request合法域名：`https://your-domain.com`
   - uploadFile合法域名：`https://your-domain.com`
   - downloadFile合法域名：`https://your-domain.com`

3. **上传代码**：
   - 使用微信开发者工具打开 `miniprogram` 目录
   - 点击"上传"按钮上传代码
   - 在微信公众平台提交审核

## 🔒 SSL 证书配置（推荐）

### 使用 Let's Encrypt 免费证书

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

## 📊 监控和维护

### 7.1 日志管理
```bash
# 查看应用日志
pm2 logs question-bank-server

# 查看 Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 日志轮转配置
sudo nano /etc/logrotate.d/question-bank
```

### 7.2 性能监控
```bash
# PM2 监控
pm2 monit

# 系统资源监控
htop
df -h
free -h
```

### 7.3 备份策略
```bash
# 数据库备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u question_user -p question_bank_db > /backup/question_bank_$DATE.sql
find /backup -name "question_bank_*.sql" -mtime +7 -delete
```

## 🚨 故障排除

### 常见问题

1. **服务无法启动**
   ```bash
   # 检查端口占用
   sudo netstat -tlnp | grep :3002
   
   # 检查日志
   pm2 logs question-bank-server
   ```

2. **数据库连接失败**
   ```bash
   # 检查 MySQL 状态
   sudo systemctl status mysql
   
   # 测试连接
   mysql -u question_user -p -h localhost question_bank_db
   ```

3. **静态文件无法访问**
   ```bash
   # 检查文件权限
   sudo chown -R www-data:www-data /var/www/question-bank/admin/dist
   sudo chmod -R 755 /var/www/question-bank/admin/dist
   ```

4. **Nginx 配置错误**
   ```bash
   # 测试配置
   sudo nginx -t
   
   # 重新加载
   sudo systemctl reload nginx
   ```

## 📋 部署检查清单

- [ ] 服务器环境准备完成
- [ ] 数据库创建和配置完成
- [ ] 代码部署完成
- [ ] 依赖安装完成
- [ ] Admin 前端构建完成
- [ ] Nginx 配置完成
- [ ] PM2 配置完成
- [ ] 数据库初始化完成
- [ ] 服务启动成功
- [ ] API 接口测试通过
- [ ] 静态文件访问正常
- [ ] SSL 证书配置完成（可选）
- [ ] 小程序域名配置完成
- [ ] 监控和备份策略配置完成

## 🔄 更新部署

### 更新代码
```bash
cd /var/www/question-bank
git pull origin main

# 更新后端
cd server
npm install --production
pm2 restart question-bank-server

# 更新前端
cd ../admin
npm install
npm run build
sudo systemctl reload nginx
```

## 📞 技术支持

如遇到部署问题，请检查：
1. 服务器日志：`pm2 logs question-bank-server`
2. Nginx 日志：`/var/log/nginx/error.log`
3. 系统日志：`journalctl -u nginx`
4. 数据库连接状态
5. 网络连接和防火墙设置

---

**注意**：请根据实际环境调整配置参数，确保生产环境的安全性。
