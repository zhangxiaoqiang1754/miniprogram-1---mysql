# 激活码功能实现说明

## 功能概述

激活码功能允许管理员创建激活码，绑定特定用户和多个科目，用户通过输入激活码来解锁对应的题库和科目进行练习。

## 数据库设计

### 1. 激活码表 (activation_codes)
- `id`: 主键
- `code`: 激活码（8位随机字符串）
- `name`: 激活码名称
- `description`: 激活码描述
- `user_id`: 绑定的用户ID（null表示未绑定）
- `status`: 状态（active/inactive/used）
- `expires_at`: 过期时间
- `used_at`: 使用时间
- `created_by`: 创建者ID

### 2. 激活码科目关联表 (activation_code_subjects)
- `id`: 主键
- `activation_code_id`: 激活码ID
- `subject_id`: 科目ID

## 后端实现

### 1. 模型定义
- `server/models/ActivationCode.js`: 激活码模型
- `server/models/ActivationCodeSubject.js`: 关联表模型
- `server/models/associations.js`: 模型关联关系

### 2. 控制器
- `server/controllers/activationCodeController.js`: 激活码业务逻辑
  - `createActivationCode`: 创建激活码
  - `getActivationCodes`: 获取激活码列表
  - `getActivationCodeById`: 获取激活码详情
  - `updateActivationCode`: 更新激活码
  - `deleteActivationCode`: 删除激活码
  - `verifyActivationCode`: 验证激活码（小程序端）
  - `getUserActivatedSubjects`: 获取用户已激活科目（小程序端）

### 3. 路由
- `server/routes/activationCodeRoutes.js`: 激活码API路由
  - `POST /api/activation-code`: 创建激活码
  - `GET /api/activation-code`: 获取激活码列表
  - `GET /api/activation-code/:id`: 获取激活码详情
  - `PUT /api/activation-code/:id`: 更新激活码
  - `DELETE /api/activation-code/:id`: 删除激活码
  - `POST /api/activation-code/verify`: 验证激活码
  - `GET /api/activation-code/user/subjects`: 获取用户已激活科目

## 前端管理界面

### 1. 激活码管理页面
- `admin/src/views/ActivationCodeManagement.vue`: 激活码管理界面
  - 激活码列表展示
  - 创建/编辑激活码
  - 科目选择功能
  - 搜索和筛选
  - 删除功能

### 2. API接口
- `admin/src/api/activationCode.js`: 前端API调用

### 3. 路由配置
- 添加激活码管理页面路由
- 更新侧边栏导航菜单

## 小程序端实现

### 1. 激活码验证页面
- `miniprogram/pages/activation/index.js`: 激活码验证逻辑
- `miniprogram/pages/activation/index.wxml`: 激活码验证界面
- `miniprogram/pages/activation/index.wxss`: 激活码验证样式
- `miniprogram/pages/activation/index.json`: 页面配置

### 2. API集成
- `miniprogram/utils/server-api.js`: 添加激活码相关API
  - `verifyActivationCode`: 验证激活码
  - `getUserActivatedSubjects`: 获取已激活科目

### 3. 主页修改
- `miniprogram/pages/home/index.js`: 修改主页逻辑
  - 只显示用户已激活的科目
  - 添加激活码快速入口
  - 修改科目点击跳转逻辑

## 功能特性

### 1. 管理员功能
- ✅ 创建激活码，绑定多个科目
- ✅ 设置激活码名称和描述
- ✅ 设置过期时间（可选）
- ✅ 查看激活码使用状态
- ✅ 编辑和删除激活码
- ✅ 搜索和筛选激活码

### 2. 用户功能
- ✅ 输入激活码进行验证
- ✅ 查看已激活的科目列表
- ✅ 直接进入已激活科目练习
- ✅ 激活码使用状态提示

### 3. 安全特性
- ✅ 激活码只能使用一次
- ✅ 支持激活码过期机制
- ✅ 用户权限验证
- ✅ 管理员权限控制

## 使用流程

### 1. 管理员创建激活码
1. 登录管理后台
2. 进入"激活码管理"页面
3. 点击"创建激活码"
4. 填写激活码信息
5. 选择要绑定的科目
6. 设置过期时间（可选）
7. 保存激活码

### 2. 用户使用激活码
1. 打开小程序
2. 点击"激活码"快速功能
3. 输入8位激活码
4. 点击"验证激活码"
5. 验证成功后科目自动解锁
6. 在主页查看已激活的科目
7. 点击科目开始练习

## 技术实现细节

### 1. 激活码生成
- 使用8位随机字符串（大写字母+数字）
- 确保唯一性（数据库唯一约束）

### 2. 科目权限控制
- 主页只显示用户已激活的科目
- 未激活的科目对用户不可见
- 支持跨题库的科目激活

### 3. 数据关联
- 激活码与用户：一对一关系
- 激活码与科目：多对多关系
- 支持级联删除和更新

### 4. 状态管理
- `active`: 有效状态，可以使用
- `inactive`: 无效状态，管理员禁用
- `used`: 已使用状态，绑定用户后自动设置

## 扩展功能建议

1. **批量激活码生成**: 支持批量创建激活码
2. **激活码统计**: 添加使用统计和分析
3. **有效期管理**: 支持激活码续期功能
4. **通知功能**: 激活码即将过期提醒
5. **导出功能**: 支持激活码列表导出

## 部署说明

1. 运行数据库迁移脚本创建激活码相关表
2. 重启服务器应用
3. 在管理后台测试激活码创建功能
4. 在小程序中测试激活码验证功能

激活码功能已完整实现，支持管理员创建和管理激活码，用户通过激活码解锁特定科目进行练习。
